name: Build macOS and Windows

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: Build (${{ matrix.target.name }})
    runs-on: ${{ matrix.target.os }}
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: macos-arm64
            os: macos-14
            rust_target: aarch64-apple-darwin
            artifact: rhaeTree-macos-arm64.zip
          - name: macos-x86_64
            os: macos-13
            rust_target: x86_64-apple-darwin
            artifact: rhaeTree-macos-x86_64.zip
          - name: windows
            os: windows-latest
            rust_target: x86_64-pc-windows-gnu
            artifact: rhaeTree-windows.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Windows GNU target
        if: matrix.target.name == 'windows'
        run: rustup target add x86_64-pc-windows-gnu

      - name: Setup MSYS2 (MinGW)
        if: matrix.target.name == 'windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-binutils
            mingw-w64-x86_64-pkgconf
            mingw-w64-x86_64-glib2
            mingw-w64-x86_64-cairo

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Import macOS signing certificate
        if: startsWith(matrix.target.name, 'macos-')
        env:
          MACOS_CERT_P12_B64: ${{ secrets.MACOS_CERT_P12_B64 }}
          MACOS_CERT_P12_PASSWORD: ${{ secrets.MACOS_CERT_P12_PASSWORD }}
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          if [[ -z "${MACOS_CERT_P12_B64}" || -z "${MACOS_CERT_P12_PASSWORD}" || -z "${MACOS_SIGNING_IDENTITY}" ]]; then
            echo "Missing required macOS signing secrets."
            exit 1
          fi

          CERT_PATH="${RUNNER_TEMP}/macos-signing-cert.p12"
          KEYCHAIN_PATH="${RUNNER_TEMP}/app-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(uuidgen)"

          printf '%s' "${MACOS_CERT_P12_B64}" | openssl base64 -d -A -out "${CERT_PATH}"

          security create-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security set-keychain-settings -lut 21600 "${KEYCHAIN_PATH}"
          security unlock-keychain -p "${KEYCHAIN_PASSWORD}" "${KEYCHAIN_PATH}"
          security import "${CERT_PATH}" \
            -k "${KEYCHAIN_PATH}" \
            -P "${MACOS_CERT_P12_PASSWORD}" \
            -f pkcs12 \
            -T /usr/bin/codesign \
            -T /usr/bin/security
          security set-key-partition-list \
            -S apple-tool:,apple:,codesign: \
            -s \
            -k "${KEYCHAIN_PASSWORD}" \
            "${KEYCHAIN_PATH}"
          security list-keychains -d user -s "${KEYCHAIN_PATH}" login.keychain-db
          security find-identity -v -p codesigning "${KEYCHAIN_PATH}"

      - name: Build macOS app bundle
        if: startsWith(matrix.target.name, 'macos-')
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          APP_VERSION="${GITHUB_REF_NAME}"
          if [[ "${APP_VERSION}" == v* ]]; then
            APP_VERSION="${APP_VERSION#v}"
          else
            APP_VERSION="1.0.0"
          fi
          cargo build --release --target "${{ matrix.target.rust_target }}"
          mkdir -p dist
          cp "target/${{ matrix.target.rust_target }}/release/rhaeTree" dist/rhaeTree
          bash scripts/build_macos_app.sh \
            --bundle-id com.yorkson.rhaetree \
            --version "${APP_VERSION}" \
            --app-name rhaeTree \
            --binary-path dist/rhaeTree
          codesign --force --sign "${MACOS_SIGNING_IDENTITY}" --options runtime --timestamp dist/rhaeTree.app/Contents/MacOS/rhaeTree
          codesign --force --sign "${MACOS_SIGNING_IDENTITY}" --options runtime --timestamp dist/rhaeTree.app
          codesign --verify --strict --verbose=2 dist/rhaeTree.app
          cd dist
          ditto -c -k --sequesterRsrc --keepParent rhaeTree.app "${{ matrix.target.artifact }}"

      - name: Clean up macOS signing keychain
        if: always() && startsWith(matrix.target.name, 'macos-')
        run: |
          KEYCHAIN_PATH="${RUNNER_TEMP}/app-signing.keychain-db"
          if [[ -f "${KEYCHAIN_PATH}" ]]; then
            security delete-keychain "${KEYCHAIN_PATH}"
          fi

      - name: Build Windows executable
        if: matrix.target.name == 'windows'
        shell: msys2 {0}
        run: |
          export PKG_CONFIG=/mingw64/bin/pkg-config
          cargo build --release --target x86_64-pc-windows-gnu
          mkdir -p dist
          cp target/x86_64-pc-windows-gnu/release/rhaeTree.exe dist/rhaeTree.exe
          cp /mingw64/bin/libcairo-2.dll dist/
          cp /mingw64/bin/libglib-2.0-0.dll dist/
          cp /mingw64/bin/libgobject-2.0-0.dll dist/
          cp /mingw64/bin/libgio-2.0-0.dll dist/
          cp /mingw64/bin/libintl-8.dll dist/
          cp /mingw64/bin/libiconv-2.dll dist/
          cp /mingw64/bin/libpng16-16.dll dist/
          cp /mingw64/bin/libfreetype-6.dll dist/
          cp /mingw64/bin/libfontconfig-1.dll dist/
          cp /mingw64/bin/libpixman-1-0.dll dist/
          cp /mingw64/bin/zlib1.dll dist/
          powershell -Command "Compress-Archive -Path dist/* -DestinationPath dist/${{ matrix.target.artifact }} -Force"

      - name: Upload macOS artifact
        if: startsWith(matrix.target.name, 'macos-')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.target.name }}
          path: dist/${{ matrix.target.artifact }}
          if-no-files-found: error

      - name: Upload Windows artifact
        if: matrix.target.name == 'windows'
        uses: actions/upload-artifact@v4
        with:
          name: rhaeTree-windows
          path: dist/${{ matrix.target.artifact }}
          if-no-files-found: error

  release:
    name: Publish GitHub Release
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Publish release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/macos-arm64/rhaeTree-macos-arm64.zip
            artifacts/macos-x86_64/rhaeTree-macos-x86_64.zip
            artifacts/rhaeTree-windows/rhaeTree-windows.zip
